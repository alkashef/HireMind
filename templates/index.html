<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Folder Browser</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
  </head>
  <body>
    <div class="tabs" role="tablist" aria-label="Sections">
      <button id="tabApplicants" class="tab-btn active" role="tab" aria-selected="true" aria-controls="paneApplicants">Applicants</button>
      <button id="tabRoles" class="tab-btn" role="tab" aria-selected="false" aria-controls="paneRoles">Roles</button>
    </div>

    <div id="paneApplicants" class="tab-pane active" role="tabpanel" aria-labelledby="tabApplicants">
  <label class="folder-label" for="folderPath">CVs Repository:</label>
      <div class="row">
        <div class="path-box">
          <input id="folderPath" type="text" readonly placeholder="No folder selected" />
        </div>
        <button id="browseBtn">Browseâ€¦</button>
        <button id="refreshBtn" title="Refresh list">Refresh</button>
      </div>
      <div id="list" class="list"></div>
      <div class="list-footer">
        <span id="fileCount" class="file-count"></span>
        <div class="actions">
          <button id="extractBtn">Extract</button>
        </div>
      </div>
      <table id="extractTable" class="data-table" aria-label="Extracted info">
        <thead>
          <tr><th>filename</th><th>timestamp</th><th>id</th></tr>
          <tr class="filter-row">
            <th><input id="filter-filename" type="text" placeholder="Filter filename" /></th>
            <th><input id="filter-timestamp" type="text" placeholder="Filter timestamp" /></th>
            <th><input id="filter-id" type="text" placeholder="Filter id" /></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="paneRoles" class="tab-pane" role="tabpanel" aria-labelledby="tabRoles">
      <div class="muted">Roles tab (placeholder)</div>
    </div>

    <script>
      async function fetchJSON(url) {
        const r = await fetch(url);
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        return await r.json();
      }

      const selected = new Set();

      function updateFooter(total) {
        const countEl = document.getElementById('fileCount');
        const totalNum = Number(total) || 0;
        const selNum = selected.size || 0;
        countEl.textContent = `${totalNum} file${totalNum === 1 ? '' : 's'} | ${selNum} selected`;
      }

      let tableRows = [];

      function getHeaderFilters() {
        return {
          filename: (document.getElementById('filter-filename')?.value || '').toLowerCase(),
          timestamp: (document.getElementById('filter-timestamp')?.value || '').toLowerCase(),
          id: (document.getElementById('filter-id')?.value || '').toLowerCase(),
        };
      }

      function renderTable() {
        const { filename: ff, timestamp: ft, id: fid } = getHeaderFilters();
        const tbody = document.querySelector('#extractTable tbody');
        const rows = tableRows.filter(r => {
          const rf = (r.filename || '').toLowerCase();
          const rt = (r.timestamp || '').toLowerCase();
          const rid = (r.id || '').toLowerCase();
          const okF = ff ? rf.includes(ff) : true;
          const okT = ft ? rt.includes(ft) : true;
          const okI = fid ? rid.includes(fid) : true;
          return okF && okT && okI;
        });
        tbody.innerHTML = rows.map(r => (
          `<tr><td>${r.filename || ''}</td><td>${r.timestamp || ''}</td><td>${r.id || ''}</td></tr>`
        )).join('');
      }

      async function refreshTable() {
        try {
          const r = await fetch('/api/extract');
          const j = await r.json();
          tableRows = Array.isArray(j.rows) ? j.rows : [];
          renderTable();
        } catch (e) {
          console.error('Failed to load table rows', e);
        }
      }

      function renderList(folder, files) {
        const box = document.getElementById('list');
        document.getElementById('folderPath').value = folder || '';
        selected.clear();
        updateFooter(0);
        if (!folder) {
          box.innerHTML = '<div class="muted">No folder selected.</div>';
          updateFooter(0);
          return;
        }
        if (!files || files.length === 0) {
          box.innerHTML = `<div class="muted">No .pdf or .docx files in: ${folder}</div>`;
          updateFooter(0);
          return;
        }
        box.innerHTML = files.map(f => `<div class="item" data-path="${encodeURIComponent(f)}">${f}</div>`).join('');
        updateFooter(files.length);

        // Attach click handlers for selection toggle (multi-select)
        box.querySelectorAll('.item').forEach(el => {
          el.addEventListener('click', () => {
            const p = decodeURIComponent(el.getAttribute('data-path'));
            if (el.classList.contains('selected')) {
              el.classList.remove('selected');
              selected.delete(p);
            } else {
              el.classList.add('selected');
              selected.add(p);
            }
            updateFooter(files.length);
          });
        });
      }

      async function loadDefault() {
        try {
          const d = await fetchJSON('/api/list-files');
          renderList(d.folder, d.files);
        } catch (e) {
          console.error(e);
        }
      }

      document.getElementById('browseBtn').addEventListener('click', async () => {
        try {
          const d = await fetchJSON('/api/pick-folder');
          renderList(d.folder, d.files);
        } catch (e) {
          console.error(e);
        }
      });

      document.getElementById('refreshBtn').addEventListener('click', loadDefault);

      // Extract button handler -> call backend API (no alerts on success)
      document.getElementById('extractBtn').addEventListener('click', async () => {
        const picked = Array.from(selected);
        if (picked.length === 0) {
          // Keep a minimal UX hint for empty selection
          alert('Select one or more files to extract.');
          return;
        }
        try {
          const r = await fetch('/api/extract', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ files: picked }),
          });
          const j = await r.json();
          if (!r.ok) throw new Error(j.error || 'Extraction failed');
          // silently refresh table; no message shown
          await refreshTable();
        } catch (e) {
          console.error(e);
          // no user alert on error per requirement
        }
      });

      loadDefault();
      refreshTable();
      ['filter-filename','filter-timestamp','filter-id'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', () => renderTable());
      });

      // Tabs logic
      const tabApplicants = document.getElementById('tabApplicants');
      const tabRoles = document.getElementById('tabRoles');
      const paneApplicants = document.getElementById('paneApplicants');
      const paneRoles = document.getElementById('paneRoles');

      function activate(tab) {
        const isApplicants = tab === 'applicants';
        tabApplicants.classList.toggle('active', isApplicants);
        tabRoles.classList.toggle('active', !isApplicants);
        tabApplicants.setAttribute('aria-selected', String(isApplicants));
        tabRoles.setAttribute('aria-selected', String(!isApplicants));
        paneApplicants.classList.toggle('active', isApplicants);
        paneRoles.classList.toggle('active', !isApplicants);
      }

      tabApplicants.addEventListener('click', () => activate('applicants'));
      tabRoles.addEventListener('click', () => activate('roles'));
    </script>
  </body>
  </html>
